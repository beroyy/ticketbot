name: Environment Validation

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate-env:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.11.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create test environment file
        run: |
          cat > .env << EOF
          # Core
          NODE_ENV=test
          TURBO_ENV=dev

          # Database (test values)
          DATABASE_URL=postgresql://test:test@localhost:5432/test
          REDIS_URL=redis://localhost:6379

          # Services
          WEB_PORT=3000
          API_PORT=3001
          BOT_PORT=3002
          WEB_URL=http://localhost:3000
          API_URL=http://localhost:3001
          NEXT_PUBLIC_API_URL=http://localhost:3001

          # Discord (test values)
          DISCORD_CLIENT_ID=test_client_id
          DISCORD_CLIENT_SECRET=test_client_secret
          DISCORD_TOKEN=test_token
          DISCORD_REDIRECT_URI=http://localhost:3001/auth/callback/discord

          # Auth
          BETTER_AUTH_SECRET=test_secret_must_be_at_least_32_characters_long
          EOF

      - name: Validate environment variables
        run: pnpm env:validate

      - name: Test environment setup script
        run: |
          # Create a minimal .env.dev file for testing
          cat > .env.dev << EOF
          NODE_ENV=development
          TURBO_ENV=dev
          PORT_LEVEL=9
          EOF

          # Run env setup without Neon (for CI)
          pnpm env:setup dev

          # Check that .env was created
          if [ ! -f .env ]; then
            echo "âŒ Environment setup failed - .env file not created"
            exit 1
          fi

          echo "âœ… Environment setup completed successfully"

      - name: Check env-config integration
        run: |
          # Verify each app can load its environment
          echo "ğŸ” Checking API env loading..."
          cd apps/api && node -e "require('./dist/env.js')" || echo "API env module will validate at runtime"

          echo "ğŸ” Checking Bot env loading..."
          cd ../bot && node -e "require('./dist/config.js')" || echo "Bot config will validate at runtime"

          echo "ğŸ” Checking Web env loading..."
          cd ../web && node -e "require('./env.js')" || echo "Web env module will validate at runtime"

          echo "âœ… Environment configuration checks completed"
